{% extends 'index.html' %}



{% block title %}
    {{ request.user.username }}'s basket
{% endblock title %}



{% block content %}
<div class="product-basket-content-container">
    <div class="product-basket-wrapper">
        <div class="product-basket-nav-bar">
            {% with request.resolver_match.url_name as url_name %}
                <a class="{% if url_name == 'product-basket' %}active-product-basket-nav-link{% else %}product-basket-nav-link{% endif %}" href="{% url 'products:product-basket' %}">Cart</a>
                <a class="{% if url_name == 'order-history' %}active-product-basket-nav-link{% else %}product-basket-nav-link{% endif %}" href="{% url 'products:order-history' %}">Order History</a>
            {% endwith %}
        </div>
        <!-- <h2 class="product-basket-header">{{ request.user.username }}'s cart</h2> -->

        <div class="order-history-header-container" style="width:100%;">
            <div class="order-history-header-text">
                <h2 class="order-history-header">{{ request.user.username }}'s Cart</h2>
                <a class="order-history-continue-shopping-btn-large" href="{% url 'products:product-list' %}">
                    <p class="order-history-continue-shopping" href="">Continue Shopping</p>
                    <span class="material-symbols-outlined">arrow_right_alt</span>
                </a>
            </div>
            <div class="order-history-user-info-container">
                <div class="order-history-user-profile-image">
                    <img src="{{ request.user.userprofile.profile_image.url }}" alt="">
                </div>
                <div class="order-history-user-profile-info">
                    <p class="order-history-username">{{ request.user.username }}</p>
                    <p>
                        {{ request.user.shippingaddress_set.all.first.first_name }} 
                        {{ request.user.shippingaddress_set.all.first.last_name }}
                    </p>
                    <p>{{ request.user.shippingaddress_set.all.first.email }}</p>
                </div>
                <a class="order-history-continue-shopping-btn-small" href="{% url 'products:product-list' %}">
                    <p class="order-history-continue-shopping" href="">Continue Shopping</p>
                </a>
            </div>
        </div>

        <div class="basket-list">
            {% for order in query_set %}
                <div class="basket-product">
                    <a class="basket-product-info-container" href="{{ order.product.get_absolute_url }}">
                        <div class="basket-product-image">
                            <img src="{{ order.product.get_product_image_url }}" alt="">
                        </div>
                        <div class="basket-product-info">
                            <h4 class="basket-product-name">
                                {{ order.product.name }} 
                            </h4>
                            <div class="basket-product-price-and-discount">
                                {% if order.product.get_discount_price %}
                                    <p class="basket-product-price">P{{ order.product.discount_price_str_format }}</p>
                                    <div class="basket-price-discount-container">
                                        <p class="basket-product-discount-price">P{{ order.product.price_str_format }}</p>
                                        <span>-10%</span>
                                    </div>
                                {% else %}
                                    <p class="basket-product-price">P{{ order.product.price_str_format }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    <form class="basket-total-product" action="{% url 'products:update-basket' order.product.id %}" method="GET">
                        <button type="button"class="basket-minus-item">
                            <span class="material-symbols-outlined">
                                remove
                            </span>
                        </button>
                        <div class="quantity">
                            Qty:
                            <input class="total-amount" type="text" readonly name='amount' value="{{ order.quantity }}" min="{{ order.quantity }}">
                        </div>
                        <button  type="button" class="basket-add-item">
                            <span class="material-symbols-outlined">
                                add
                            </span>
                        </button>
                        <button class='update-or-delete' type="submit">Remove</button>
                    </form>
                    {% for obj in order_total %}
                        {% if order.product.id == obj.id %}
                            <h4 class="total-price">P{{ obj.order_total }}</h4>
                            <!-- coming from context_processor order_total -->
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Small screen -->
                <div class="small-screen-basket-product">
                    <a href="{{ order.product.get_absolute_url }}" class="basket-product-link">
                        <img src="{{ order.product.get_product_image_url }}" alt="">
                    </a>
                    <div class="basket-product-info-container">
                        <div class="basket-product-info">
                            <h4 class="basket-product-name">
                                {{ order.product.name }} 
                            </h4>
                            <div class="basket-product-price-and-discount">
                                {% if order.product.get_discount_price %}
                                    <div class="basket-price-discount-container">
                                        <p class="small-screen-basket-product-price">Price:<span>P{{ order.product.discount_price_str_format }}</span></p>
                                        <div class="basket-price-line-through">
                                            <p class="basket-product-discount-price">P{{ order.product.price_str_format }}</p>
                                            <span>-10%</span>
                                        </div>
                                    </div>
                                {% else %}
                                    <p class="small-screen-basket-product-price">Price:<span>P{{ order.product.price_str_format }}</span></p>
                                {% endif %}
                            </div>
                        </div>
                        {% for obj in order_total %}
                            {% if order.product.id == obj.id %}
                                <h4 class="small-screen-total-price">Total:<span>P{{ obj.order_total }}</span></h4>
                                <!-- coming from context_processor order_total -->
                            {% endif %}
                        {% endfor %}
                        <form class="basket-total-product" action="{% url 'products:update-basket' order.product.id %}" method="GET">
                            <div>
                                <button type="button"class="basket-minus-item">
                                    <span class="material-symbols-outlined">
                                        remove
                                    </span>
                                </button>
                                <div class="quantity">
                                    Qty:
                                    <input class="total-amount" type="text" readonly name='amount' value="{{ order.quantity }}" min="1">
                                </div>
                                <button  type="button" class="basket-add-item">
                                    <span class="material-symbols-outlined">
                                        add
                                    </span>
                                </button>
                            </div>
                            <button class='update-or-delete' type="submit">Remove</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
        <div class="basket-sub-total-container">
            <div class="basket-sub-total">
                <h2 class="basket-order-summary-header">Order Summary</h2>
                <div class="sub-total-basket-quantity">
                    <h4>Quantity</h4>
                    {% if num_of_product > 1 %}
                        <p>{{ num_of_product }} items</p>
                    {% else %}
                        <p>{{ num_of_product }} item</p>
                    {% endif %}
                    <!-- coming from context_processors.py -->
                </div>
                {% if discount_amount %}
                    <div class="sub-total-basket-savings">
                        <h4>Saved</h4>
                        <p>P{{ discount_amount }}</p> 
                        <!-- coming from context_processors.py -->
                    </div>
                {% endif %}
                <div class="sub-total-basket-subtotal">
                    <h4>Sub-total</h4>
                    <p>P{{ sub_total }}</p>
                    <!-- coming from context_processors.py -->
                </div>
                <div class="sub-total-basket-subtotal">
                    <h4>VAT<small>12%</small></h4>
                    <p>P{{ vat }}</p>
                    <!-- coming from context_processors.py -->
                </div>
                <div class="sub-total-basket-subtotal">
                    <h4>Total</h4>
                    <p>P{{ total }}</p>
                    <!-- coming from context_processors.py -->
                </div>
                <div class="sub-total-btns">
                    <a class="basket-checkout-btn" href="{% url 'products:shipping-address' %}">Go to Checkout</a>
                    <a class="basket-continue-shopping-btn" href="{% url 'products:product-list' %}">Continue Shopping</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    const basketProduct = document.querySelectorAll('.basket-product')
    const basketMinusItem = document.querySelectorAll('.basket-minus-item')
    const basketAddItem = document.querySelectorAll('.basket-add-item')
    const totalAmount = document.querySelectorAll('.total-amount')
    

    basketAddItem.forEach((btn) => {
        btn.addEventListener('click', (e) => {
            const input = e.currentTarget.previousElementSibling.firstElementChild
            const submitButton = e.currentTarget.nextElementSibling
            submitButton.textContent = 'Update'
            input.value ++
        })
    })
    
    basketMinusItem.forEach((btn) => {
        btn.addEventListener('click', (e) => {
            const input = e.currentTarget.nextElementSibling.firstElementChild
            const submitButton = e.currentTarget.nextElementSibling.nextElementSibling.nextElementSibling
            if(input.value > 1){
                input.value --
                submitButton.textContent = 'Update'
            } if(input.value <= 1) {
                    submitButton.textContent = 'Remove'
                    input.value = 1
            }
        })
    })
    
</script>

{% endblock content %}
